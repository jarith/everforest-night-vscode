name: Publish Extension

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version bump type
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  verify_ci:
    name: Verify CI status
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    steps:
      - name: Require latest CI run success for this commit
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo
            const workflowId = 'ci.yml'
            const headSha = context.sha

            const runs = await github.paginate(github.rest.actions.listWorkflowRuns, {
              owner,
              repo,
              workflow_id: workflowId,
              head_sha: headSha,
              per_page: 100,
            })

            if (runs.length === 0) {
              core.setFailed(
                `Publishing is blocked: no CI runs from ${workflowId} found for commit ${headSha}.`
              )
              return
            }

            runs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            const latestRun = runs[0]

            if (latestRun.status !== 'completed') {
              core.setFailed(
                `Publishing is blocked: latest CI run is still ${latestRun.status} (${latestRun.html_url}).`
              )
              return
            }

            if (latestRun.conclusion !== 'success') {
              core.setFailed(
                `Publishing is blocked: latest CI run concluded "${latestRun.conclusion}" (${latestRun.html_url}).`
              )
              return
            }

            core.info(`Latest CI run passed: ${latestRun.html_url}`)

  publish:
    needs: verify_ci
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Bump version
        run: |
          npm version "${{ inputs.version }}" --no-git-tag-version
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Package VSIX
        run: yarn run package

      - name: Publish to VS Code Marketplace
        run: yarn run release:vsce --packagePath build/everforest-night-vscode.vsix --skip-duplicate
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX
        run: yarn run publish:ovsx
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}

      - name: Commit and tag release
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "v${VERSION}"
          git tag "v${VERSION}"
          git push origin HEAD:${{ github.ref_name }} --tags
